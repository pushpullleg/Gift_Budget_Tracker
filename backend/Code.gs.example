/**
 * Gift Budget Tracker - Google Apps Script Backend
 * 
 * This file handles all server-side logic including:
 * - API endpoint for expense submission
 * - Budget calculation from Google Sheets
 * - Undo functionality
 * - CORS handling
 * 
 * SETUP INSTRUCTIONS:
 * 1. Open Google Apps Script (script.google.com)
 * 2. Create a new project
 * 3. Replace the default code with this file
 * 4. Update the CONFIG values below
 * 5. Deploy as a Web App
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

/**
 * Application configuration
 * 
 * Uses Script Properties (Google Apps Script's equivalent of environment variables)
 * for secure storage of sensitive values.
 * 
 * SETUP: Run the setupConfig() function once to set your values
 */
function getConfig() {
  const properties = PropertiesService.getScriptProperties();
  
  return {
    SPREADSHEET_ID: properties.getProperty('SPREADSHEET_ID') || '',
    API_KEY: properties.getProperty('API_KEY') || '',
    SHEET_NAME: properties.getProperty('SHEET_NAME') || 'Transactions',
    STARTING_BUDGET: parseFloat(properties.getProperty('STARTING_BUDGET')) || 2500
  };
}

/**
 * ONE-TIME SETUP: Run this function to set your configuration values
 * 
 * Instructions:
 * 1. Replace the values below with your actual values
 * 2. Run this function once (Run â†’ setupConfig)
 * 3. Delete this function or comment it out after setup (for security)
 * 4. Your values are now stored securely in Script Properties
 */
function setupConfig() {
  const properties = PropertiesService.getScriptProperties();
  
  // Set your values here (replace with your actual values)
  properties.setProperties({
    'SPREADSHEET_ID': 'YOUR_SPREADSHEET_ID_HERE',  // Replace with your Sheet ID
    'API_KEY': 'YOUR_API_KEY_HERE',                 // Replace with your API key
    'SHEET_NAME': 'Transactions',                   // Usually 'Transactions'
    'STARTING_BUDGET': '2500'                       // Your budget amount as string
  });
  
  Logger.log('Configuration saved successfully!');
  Logger.log('You can now delete or comment out the setupConfig() function.');
}

// For backward compatibility, create a CONFIG constant that reads from properties
// This allows existing code to work without changes
const CONFIG = getConfig();

// ============================================================================
// CORS HANDLING
// ============================================================================

/**
 * Handle OPTIONS request for CORS preflight
 * Required for cross-origin requests from GitHub Pages
 */
function doOptions() {
  // CORS headers are handled automatically by Google Apps Script when deployed with "Anyone" access
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================================================
// MAIN API ENDPOINT
// ============================================================================

/**
 * Main POST endpoint - receives expense data from web form
 * 
 * @param {Object} e - Event object containing postData
 * @returns {TextOutput} JSON response with success status and budget info
 */
function doPost(e) {
  // Note: CORS headers are automatically handled by Google Apps Script when deployed with "Anyone" access
  // No need to manually set headers

  try {
    // Parse request data
    const requestData = JSON.parse(e.postData.contents);
    
    // Handle different actions
    if (requestData.action === 'getBudget') {
      return handleGetBudget();
    }
    
    if (requestData.action === 'getLastEntry') {
      return getLastEntry(requestData);
    }
    
    if (requestData.action === 'undo') {
      return handleUndo(requestData);
    }
    
    // Default action: add expense
    return handleAddExpense(requestData);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Server error: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================================================
// REQUEST HANDLERS
// ============================================================================

/**
 * Handles adding a new expense
 * 
 * @param {Object} requestData - Request data containing apiKey, amount, category, notes
 * @param {Object} headers - CORS headers
 * @returns {TextOutput} JSON response
 */
function handleAddExpense(requestData) {
  // Validate API key
  if (requestData.apiKey !== CONFIG.API_KEY) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid API key'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Validate input
  const amount = parseFloat(requestData.amount);
  if (isNaN(amount) || amount <= 0) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid amount'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const validCategories = ['Groceries', 'Dining', 'Shopping', 'Travel', 'Health', 'Personal', 'Gifts', 'Misc'];
  if (!validCategories.includes(requestData.category)) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid category'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Get sheet and append data
  const sheet = getSheet();
  const timestamp = new Date();
  const row = [
    timestamp,
    amount,
    requestData.category,
    requestData.notes || ''
  ];
  
  sheet.appendRow(row);
  
  // Get updated budget info
  const budgetInfo = getBudgetInfo();
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: 'Expense added successfully',
    budget: budgetInfo
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Gets the last expense entry details (without deleting)
 * Used to show user what will be undone
 * 
 * @param {Object} requestData - Request data (for API key validation)
 * @param {Object} headers - CORS headers
 * @returns {TextOutput} JSON response with last entry details
 */
function getLastEntry(requestData) {
  // Validate API key
  if (requestData.apiKey !== CONFIG.API_KEY) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid API key'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  const sheet = getSheet();
  const lastRow = sheet.getLastRow();
  
  if (lastRow <= 1) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'No expenses found'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Get last row data (excluding header)
  const lastRowData = sheet.getRange(lastRow, 1, 1, 4).getValues()[0];
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    entry: {
      date: lastRowData[0],
      amount: lastRowData[1],
      category: lastRowData[2],
      notes: lastRowData[3] || ''
    }
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handles undoing the last expense entry
 * 
 * @param {Object} requestData - Request data
 * @param {Object} headers - CORS headers
 * @returns {TextOutput} JSON response
 */
function handleUndo(requestData) {
  // Validate API key
  if (requestData.apiKey !== CONFIG.API_KEY) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid API key'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const sheet = getSheet();
  const lastRow = sheet.getLastRow();
  
  if (lastRow <= 1) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'No expenses to undo'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Get last entry details before deleting (for confirmation message)
  const lastRowData = sheet.getRange(lastRow, 1, 1, 4).getValues()[0];
  const deletedEntry = {
    amount: lastRowData[1],
    category: lastRowData[2],
    date: lastRowData[0]
  };
  
  // Delete last row (excluding header)
  sheet.deleteRow(lastRow);
  
  // Get updated budget info
  const budgetInfo = getBudgetInfo();
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: 'Last expense deleted',
    deletedEntry: deletedEntry,
    budget: budgetInfo
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handles fetching current budget information
 * 
 * @param {Object} headers - CORS headers
 * @returns {TextOutput} JSON response with budget data
 */
function handleGetBudget() {
  const budgetInfo = getBudgetInfo();
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    budget: budgetInfo
  })).setMimeType(ContentService.MimeType.JSON);
}

// ============================================================================
// SHEET OPERATIONS
// ============================================================================

/**
 * Gets the Google Sheet object
 * 
 * @returns {Sheet} The Transactions sheet
 */
function getSheet() {
  const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  
  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = spreadsheet.insertSheet(CONFIG.SHEET_NAME);
    // Add header row
    sheet.appendRow(['Date', 'Amount', 'Category', 'Notes']);
  }
  
  return sheet;
}

// ============================================================================
// BUDGET CALCULATION
// ============================================================================

/**
 * Calculates current budget information from transactions
 * 
 * @returns {Object} Budget object with startingBudget, totalSpent, remaining
 */
function getBudgetInfo() {
  const sheet = getSheet();
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  // Skip header row (row 1)
  let totalSpent = 0;
  for (let i = 1; i < values.length; i++) {
    const amount = parseFloat(values[i][1]); // Amount is in column B (index 1)
    if (!isNaN(amount) && amount > 0) {
      totalSpent += amount;
    }
  }
  
  const remaining = CONFIG.STARTING_BUDGET - totalSpent;
  
  return {
    startingBudget: CONFIG.STARTING_BUDGET,
    totalSpent: totalSpent,
    remaining: remaining
  };
}

